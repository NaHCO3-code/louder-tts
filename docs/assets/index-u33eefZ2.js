const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/wrapper-CviSselG-BXl6tbvB.js","assets/__vite-browser-external-BIHI7g3E.js"])))=>i.map(i=>d[i]);
(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))o(s);new MutationObserver(s=>{for(const i of s)if(i.type==="childList")for(const r of i.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&o(r)}).observe(document,{childList:!0,subtree:!0});function e(s){const i={};return s.integrity&&(i.integrity=s.integrity),s.referrerPolicy&&(i.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?i.credentials="include":s.crossOrigin==="anonymous"?i.credentials="omit":i.credentials="same-origin",i}function o(s){if(s.ep)return;s.ep=!0;const i=e(s);fetch(s.href,i)}})();const mt="modulepreload",gt=function(n){return"/continuation-writing-helper/"+n},je={},$e=function(t,e,o){let s=Promise.resolve();if(e&&e.length>0){document.getElementsByTagName("link");const r=document.querySelector("meta[property=csp-nonce]"),a=(r==null?void 0:r.nonce)||(r==null?void 0:r.getAttribute("nonce"));s=Promise.allSettled(e.map(c=>{if(c=gt(c),c in je)return;je[c]=!0;const f=c.endsWith(".css"),h=f?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${c}"]${h}`))return;const u=document.createElement("link");if(u.rel=f?"stylesheet":mt,f||(u.as="script"),u.crossOrigin="",u.href=c,a&&u.setAttribute("nonce",a),document.head.appendChild(u),f)return new Promise((_,v)=>{u.addEventListener("load",_),u.addEventListener("error",()=>v(new Error(`Unable to preload CSS for ${c}`)))})}))}function i(r){const a=new Event("vite:preloadError",{cancelable:!0});if(a.payload=r,window.dispatchEvent(a),!a.defaultPrevented)throw r}return s.then(r=>{for(const a of r||[])a.status==="rejected"&&i(a.reason);return t().catch(i)})};var wt=Object.defineProperty,yt=(n,t,e)=>t in n?wt(n,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):n[t]=e,d=(n,t,e)=>(yt(n,typeof t!="symbol"?t+"":t,e),e),Ve=(n,t,e)=>{if(!t.has(n))throw TypeError("Cannot "+e)},X=(n,t,e)=>(Ve(n,t,"read from private field"),t.get(n)),vt=(n,t,e)=>{if(t.has(n))throw TypeError("Cannot add the same private member more than once");t instanceof WeakSet?t.add(n):t.set(n,e)},bt=(n,t,e,o)=>(Ve(n,t,"write to private field"),t.set(n,e),e),q,ye=new Intl.Collator(0,{numeric:1}).compare;function Ke(n,t,e){return n=n.split("."),t=t.split("."),ye(n[0],t[0])||ye(n[1],t[1])||(t[2]=t.slice(2).join("."),e=/[.-]/.test(n[2]=n.slice(2).join(".")),e==/[.-]/.test(t[2])?ye(n[2],t[2]):e?-1:1)}const Et="host",Ze="queue/data",St="queue/join",ze="upload",$t="login",kt="config",Rt="info",Ot="runtime",Tt="sleeptime",Lt="heartbeat",It="component_server",At="reset",Pt="cancel",xt="https://gradio-space-api-fetcher-v2.hf.space/api",Qe="This application is currently busy. Please try again. ",G="Connection errored out. ",j="Could not resolve app config. ",Ct="Could not get space status. ",Dt="Could not get API info. ",Te="Space metadata could not be loaded. ",Ut="Invalid URL. A full URL path is required.",Nt="Not authorized to access this space. ",Xe="Invalid credentials. Could not login. ",Bt="Login credentials are required to access this space.",qt="File system access is only available in Node.js environments",Ye="Root URL not found in client config",jt="Error uploading file";function et(n,t,e){return t.startsWith("http://")||t.startsWith("https://")?e?n:t:n+t}async function Fe(n,t,e){try{return(await(await fetch(`https://huggingface.co/api/spaces/${n}/jwt`,{headers:{Authorization:`Bearer ${t}`,...e?{Cookie:e}:{}}})).json()).token||!1}catch{return!1}}function zt(n){let t={};return n.forEach(({api_name:e,id:o})=>{e&&(t[e]=o)}),t}async function Ft(n){var t;const e=this.options.hf_token?{Authorization:`Bearer ${this.options.hf_token}`}:{};if(e["Content-Type"]="application/json",typeof window<"u"&&window.gradio_config&&location.origin!=="http://localhost:9876"&&!window.gradio_config.dev_mode){const o=window.gradio_config.root,s=window.gradio_config;let i=et(n,s.root,!1);return s.root=i,{...s,path:o}}else if(n){const o=st(n,kt),s=await this.fetch(o,{headers:e,credentials:"include"});if((s==null?void 0:s.status)===401&&!this.options.auth)throw new Error(Bt);if((s==null?void 0:s.status)===401&&this.options.auth)throw new Error(Xe);if((s==null?void 0:s.status)===200){let i=await s.json();return i.path=i.path??"",i.root=n,(t=i.dependencies)==null||t.forEach((r,a)=>{r.id===void 0&&(r.id=a)}),i}else if((s==null?void 0:s.status)===401)throw new Error(Nt);throw new Error(j)}throw new Error(j)}async function Gt(){const{http_protocol:n,host:t}=await ue(this.app_reference,this.options.hf_token);try{if(this.options.auth){const e=await tt(n,t,this.options.auth,this.fetch,this.options.hf_token);e&&this.set_cookies(e)}}catch(e){throw Error(e.message)}}async function tt(n,t,e,o,s){const i=new FormData;i.append("username",e==null?void 0:e[0]),i.append("password",e==null?void 0:e[1]);let r={};s&&(r.Authorization=`Bearer ${s}`);const a=await o(`${n}//${t}/${$t}`,{headers:r,method:"POST",body:i,credentials:"include"});if(a.status===200)return a.headers.get("set-cookie");throw a.status===401?new Error(Xe):new Error(Te)}function ve(n){if(n.startsWith("http")){const{protocol:t,host:e,pathname:o}=new URL(n);return{ws_protocol:t==="https:"?"wss":"ws",http_protocol:t,host:e+(o!=="/"?o:"")}}else if(n.startsWith("file:"))return{ws_protocol:"ws",http_protocol:"http:",host:"lite.local"};return{ws_protocol:"wss",http_protocol:"https:",host:new URL(n).host}}const nt=n=>{let t=[];return n.split(/,(?=\s*[^\s=;]+=[^\s=;]+)/).forEach(o=>{const[s,i]=o.split(";")[0].split("=");s&&i&&t.push(`${s.trim()}=${i.trim()}`)}),t},Le=/^[a-zA-Z0-9_\-\.]+\/[a-zA-Z0-9_\-\.]+$/,Mt=/.*hf\.space\/{0,1}.*$/;async function ue(n,t){const e={};t&&(e.Authorization=`Bearer ${t}`);const o=n.trim().replace(/\/$/,"");if(Le.test(o))try{const i=(await(await fetch(`https://huggingface.co/api/spaces/${o}/${Et}`,{headers:e})).json()).host;return{space_id:n,...ve(i)}}catch{throw new Error(Te)}if(Mt.test(o)){const{ws_protocol:s,http_protocol:i,host:r}=ve(o);return{space_id:r.split("/")[0].replace(".hf.space",""),ws_protocol:s,http_protocol:i,host:r}}return{space_id:!1,...ve(o)}}const st=(...n)=>{try{return n.reduce((t,e)=>(t=t.replace(/\/+$/,""),e=e.replace(/^\/+/,""),new URL(e,t+"/").toString()))}catch{throw new Error(Ut)}};function Wt(n,t,e){const o={named_endpoints:{},unnamed_endpoints:{}};return Object.keys(n).forEach(s=>{(s==="named_endpoints"||s==="unnamed_endpoints")&&(o[s]={},Object.entries(n[s]).forEach(([i,{parameters:r,returns:a}])=>{var c,f,h,u;const _=((c=t.dependencies.find(l=>l.api_name===i||l.api_name===i.replace("/","")))==null?void 0:c.id)||e[i.replace("/","")]||-1,v=_!==-1?(f=t.dependencies.find(l=>l.id==_))==null?void 0:f.types:{generator:!1,cancel:!1};if(_!==-1&&((u=(h=t.dependencies.find(l=>l.id==_))==null?void 0:h.inputs)==null?void 0:u.length)!==r.length){const l=t.dependencies.find(g=>g.id==_).inputs.map(g=>{var O;return(O=t.components.find(I=>I.id===g))==null?void 0:O.type});try{l.forEach((g,O)=>{if(g==="state"){const I={component:"state",example:null,parameter_default:null,parameter_has_default:!0,parameter_name:null,hidden:!0};r.splice(O,0,I)}})}catch(g){console.error(g)}}const z=(l,g,O,I)=>({...l,description:Ht(l==null?void 0:l.type,O),type:Jt(l==null?void 0:l.type,g,O,I)||""});o[s][i]={parameters:r.map(l=>z(l,l==null?void 0:l.component,l==null?void 0:l.serializer,"parameter")),returns:a.map(l=>z(l,l==null?void 0:l.component,l==null?void 0:l.serializer,"return")),type:v}}))}),o}function Jt(n,t,e,o){if(t==="Api")return n.type;switch(n==null?void 0:n.type){case"string":return"string";case"boolean":return"boolean";case"number":return"number"}if(e==="JSONSerializable"||e==="StringSerializable")return"any";if(e==="ListStringSerializable")return"string[]";if(t==="Image")return o==="parameter"?"Blob | File | Buffer":"string";if(e==="FileSerializable")return(n==null?void 0:n.type)==="array"?o==="parameter"?"(Blob | File | Buffer)[]":"{ name: string; data: string; size?: number; is_file?: boolean; orig_name?: string}[]":o==="parameter"?"Blob | File | Buffer":"{ name: string; data: string; size?: number; is_file?: boolean; orig_name?: string}";if(e==="GallerySerializable")return o==="parameter"?"[(Blob | File | Buffer), (string | null)][]":"[{ name: string; data: string; size?: number; is_file?: boolean; orig_name?: string}, (string | null))][]"}function Ht(n,t){return t==="GallerySerializable"?"array of [file, label] tuples":t==="ListStringSerializable"?"array of strings":t==="FileSerializable"?"array of files or single file":n==null?void 0:n.description}function be(n,t){switch(n.msg){case"send_data":return{type:"data"};case"send_hash":return{type:"hash"};case"queue_full":return{type:"update",status:{queue:!0,message:Qe,stage:"error",code:n.code,success:n.success}};case"heartbeat":return{type:"heartbeat"};case"unexpected_error":return{type:"unexpected_error",status:{queue:!0,message:n.message,stage:"error",success:!1}};case"estimation":return{type:"update",status:{queue:!0,stage:t||"pending",code:n.code,size:n.queue_size,position:n.rank,eta:n.rank_eta,success:n.success}};case"progress":return{type:"update",status:{queue:!0,stage:"pending",code:n.code,progress_data:n.progress_data,success:n.success}};case"log":return{type:"log",data:n};case"process_generating":return{type:"generating",status:{queue:!0,message:n.success?null:n.output.error,stage:n.success?"generating":"error",code:n.code,progress_data:n.progress_data,eta:n.average_duration,changed_state_ids:n.success?n.output.changed_state_ids:void 0},data:n.success?n.output:null};case"process_streaming":return{type:"streaming",status:{queue:!0,message:n.output.error,stage:"streaming",time_limit:n.time_limit,code:n.code,progress_data:n.progress_data,eta:n.eta},data:n.output};case"process_completed":return"error"in n.output?{type:"update",status:{queue:!0,title:n.output.title,message:n.output.error,visible:n.output.visible,duration:n.output.duration,stage:"error",code:n.code,success:n.success}}:{type:"complete",status:{queue:!0,message:n.success?void 0:n.output.error,stage:n.success?"complete":"error",code:n.code,progress_data:n.progress_data,changed_state_ids:n.success?n.output.changed_state_ids:void 0},data:n.success?n.output:null};case"process_starts":return{type:"update",status:{queue:!0,stage:"pending",code:n.code,size:n.rank,position:0,success:n.success,eta:n.eta},original_msg:"process_starts"}}return{type:"none",status:{stage:"error",queue:!0}}}const Vt=(n=[],t)=>{const e=t?t.parameters:[];if(Array.isArray(n))return n.length>e.length&&console.warn("Too many arguments provided for the endpoint."),n;const o=[],s=Object.keys(n);return e.forEach((i,r)=>{if(n.hasOwnProperty(i.parameter_name))o[r]=n[i.parameter_name];else if(i.parameter_has_default)o[r]=i.parameter_default;else throw new Error(`No value provided for required parameter: ${i.parameter_name}`)}),s.forEach(i=>{if(!e.some(r=>r.parameter_name===i))throw new Error(`Parameter \`${i}\` is not a valid keyword argument. Please refer to the API for usage.`)}),o.forEach((i,r)=>{if(i===void 0&&!e[r].parameter_has_default)throw new Error(`No value provided for required parameter: ${e[r].parameter_name}`)}),o};async function Kt(){if(this.api_info)return this.api_info;const{hf_token:n}=this.options,{config:t}=this,e={"Content-Type":"application/json"};if(n&&(e.Authorization=`Bearer ${n}`),!!t)try{let o,s;if(typeof window<"u"&&window.gradio_api_info)s=window.gradio_api_info;else{if(Ke((t==null?void 0:t.version)||"2.0.0","3.30")<0)o=await this.fetch(xt,{method:"POST",body:JSON.stringify({serialize:!1,config:JSON.stringify(t)}),headers:e,credentials:"include"});else{const i=st(t.root,this.api_prefix,Rt);o=await this.fetch(i,{headers:e,credentials:"include"})}if(!o.ok)throw new Error(G);s=await o.json()}return"api"in s&&(s=s.api),s.named_endpoints["/predict"]&&!s.unnamed_endpoints[0]&&(s.unnamed_endpoints[0]=s.named_endpoints["/predict"]),Wt(s,t,this.api_map)}catch(o){""+o.message}}async function Zt(n,t,e){var o;const s={};(o=this==null?void 0:this.options)!=null&&o.hf_token&&(s.Authorization=`Bearer ${this.options.hf_token}`);const i=1e3,r=[];let a;for(let c=0;c<t.length;c+=i){const f=t.slice(c,c+i),h=new FormData;f.forEach(_=>{h.append("files",_)});try{const _=e?`${n}${this.api_prefix}/${ze}?upload_id=${e}`:`${n}${this.api_prefix}/${ze}`;a=await this.fetch(_,{method:"POST",body:h,headers:s,credentials:"include"})}catch(_){throw new Error(G+_.message)}if(!a.ok){const _=await a.text();return{error:`HTTP ${a.status}: ${_}`}}const u=await a.json();u&&r.push(...u)}return{files:r}}async function Qt(n,t,e,o){let s=(Array.isArray(n)?n:[n]).map(r=>r.blob);const i=s.filter(r=>r.size>(o??1/0));if(i.length)throw new Error(`File size exceeds the maximum allowed size of ${o} bytes: ${i.map(r=>r.name).join(", ")}`);return await Promise.all(await this.upload_files(t,s,e).then(async r=>{if(r.error)throw new Error(r.error);return r.files?r.files.map((a,c)=>new Ie({...n[c],path:a,url:`${t}${this.api_prefix}/file=${a}`})):[]}))}class Ie{constructor({path:t,url:e,orig_name:o,size:s,blob:i,is_stream:r,mime_type:a,alt_text:c,b64:f}){d(this,"path"),d(this,"url"),d(this,"orig_name"),d(this,"size"),d(this,"blob"),d(this,"is_stream"),d(this,"mime_type"),d(this,"alt_text"),d(this,"b64"),d(this,"meta",{_type:"gradio.FileData"}),this.path=t,this.url=e,this.orig_name=o,this.size=s,this.blob=e?void 0:i,this.is_stream=r,this.mime_type=a,this.alt_text=c,this.b64=f}}class Xt{constructor(t,e){d(this,"type"),d(this,"command"),d(this,"meta"),d(this,"fileData"),this.type="command",this.command=t,this.meta=e}}typeof process<"u"&&process.versions&&process.versions.node;function Ge(n,t,e){for(;e.length>1;){const s=e.shift();if(typeof s=="string"||typeof s=="number")n=n[s];else throw new Error("Invalid key type")}const o=e.shift();if(typeof o=="string"||typeof o=="number")n[o]=t;else throw new Error("Invalid key type")}async function ke(n,t=void 0,e=[],o=!1,s=void 0){if(Array.isArray(n)){let i=[];return await Promise.all(n.map(async(r,a)=>{var c;let f=e.slice();f.push(String(a));const h=await ke(n[a],o?((c=s==null?void 0:s.parameters[a])==null?void 0:c.component)||void 0:t,f,!1,s);i=i.concat(h)})),i}else{if(globalThis.Buffer&&n instanceof globalThis.Buffer||n instanceof Blob)return[{path:e,blob:new Blob([n]),type:t}];if(typeof n=="object"&&n!==null){let i=[];for(const r of Object.keys(n)){const a=[...e,r],c=n[r];i=i.concat(await ke(c,void 0,a,!1,s))}return i}}return[]}function Yt(n,t){var e,o;let s=(o=(e=t==null?void 0:t.dependencies)==null?void 0:e.find(i=>i.id==n))==null?void 0:o.queue;return s!=null?!s:!t.enable_queue}function en(n,t){return new Promise((e,o)=>{const s=new MessageChannel;s.port1.onmessage=({data:i})=>{s.port1.close(),e(i)},window.parent.postMessage(n,t,[s.port2])})}function Y(n,t,e,o,s=!1){if(o==="input"&&!s)throw new Error("Invalid code path. Cannot skip state inputs for input.");if(o==="output"&&s)return n;let i=[],r=0;const a=o==="input"?t.inputs:t.outputs;for(let c=0;c<a.length;c++){const f=a[c],h=e.find(u=>u.id===f);if((h==null?void 0:h.type)==="state"){if(s)if(n.length===a.length){const u=n[r];i.push(u),r++}else i.push(null);else{r++;continue}continue}else{const u=n[r];i.push(u),r++}}return i}async function tn(n,t,e){const o=this;await nn(o,t);const s=await ke(t,void 0,[],!0,e);return(await Promise.all(s.map(async({path:r,blob:a,type:c})=>{if(!a)return{path:r,type:c};const f=await o.upload_files(n,[a]),h=f.files&&f.files[0];return{path:r,file_url:h,type:c,name:typeof File<"u"&&a instanceof File?a==null?void 0:a.name:void 0}}))).forEach(({path:r,file_url:a,type:c,name:f})=>{if(c==="Gallery")Ge(t,a,r);else if(a){const h=new Ie({path:a,orig_name:f});Ge(t,h,r)}}),t}async function nn(n,t){var e,o;if(!(((e=n.config)==null?void 0:e.root)||((o=n.config)==null?void 0:o.root_url)))throw new Error(Ye);await ot(n,t)}async function ot(n,t,e=[]){for(const o in t)t[o]instanceof Xt?await sn(n,t,o):typeof t[o]=="object"&&t[o]!==null&&await ot(n,t[o],[...e,o])}async function sn(n,t,e){var o,s;let i=t[e];const r=((o=n.config)==null?void 0:o.root)||((s=n.config)==null?void 0:s.root_url);if(!r)throw new Error(Ye);try{let a,c;if(typeof process<"u"&&process.versions&&process.versions.node){const _=await $e(()=>import("./__vite-browser-external-BIHI7g3E.js"),[]);c=(await $e(()=>import("./__vite-browser-external-BIHI7g3E.js"),[])).resolve(process.cwd(),i.meta.path),a=await _.readFile(c)}else throw new Error(qt);const f=new Blob([a],{type:"application/octet-stream"}),h=await n.upload_files(r,[f]),u=h.files&&h.files[0];if(u){const _=new Ie({path:u,orig_name:i.meta.name||""});t[e]=_}}catch(a){console.error(jt,a)}}async function on(n,t,e){const o={"Content-Type":"application/json"};this.options.hf_token&&(o.Authorization=`Bearer ${this.options.hf_token}`);try{var s=await this.fetch(n,{method:"POST",body:JSON.stringify(t),headers:{...o,...e},credentials:"include"})}catch{return[{error:G},500]}let i,r;try{i=await s.json(),r=s.status}catch(a){i={error:`Could not parse server response: ${a}`},r=500}return[i,r]}async function rn(n,t={}){let e=!1,o=!1;if(!this.config)throw new Error("Could not resolve app config");if(typeof n=="number")this.config.dependencies.find(s=>s.id==n);else{const s=n.replace(/^\//,"");this.config.dependencies.find(i=>i.id==this.api_map[s])}return new Promise(async(s,i)=>{const r=this.submit(n,t,null,null,!0);let a;for await(const c of r)c.type==="data"&&(o&&s(a),e=!0,a=c),c.type==="status"&&(c.stage==="error"&&i(c),c.stage==="complete"&&(o=!0,e&&s(a)))})}async function ee(n,t,e){let o=t==="subdomain"?`https://huggingface.co/api/spaces/by-subdomain/${n}`:`https://huggingface.co/api/spaces/${n}`,s,i;try{if(s=await fetch(o),i=s.status,i!==200)throw new Error;s=await s.json()}catch{e({status:"error",load_status:"error",message:Ct,detail:"NOT_FOUND"});return}if(!s||i!==200)return;const{runtime:{stage:r},id:a}=s;switch(r){case"STOPPED":case"SLEEPING":e({status:"sleeping",load_status:"pending",message:"Space is asleep. Waking it up...",detail:r}),setTimeout(()=>{ee(n,t,e)},1e3);break;case"PAUSED":e({status:"paused",load_status:"error",message:"This space has been paused by the author. If you would like to try this demo, consider duplicating the space.",detail:r,discussions_enabled:await Me(a)});break;case"RUNNING":case"RUNNING_BUILDING":e({status:"running",load_status:"complete",message:"Space is running.",detail:r});break;case"BUILDING":e({status:"building",load_status:"pending",message:"Space is building...",detail:r}),setTimeout(()=>{ee(n,t,e)},1e3);break;case"APP_STARTING":e({status:"starting",load_status:"pending",message:"Space is starting...",detail:r}),setTimeout(()=>{ee(n,t,e)},1e3);break;default:e({status:"space_error",load_status:"error",message:"This space is experiencing an issue.",detail:r,discussions_enabled:await Me(a)});break}}const it=async(n,t)=>{let e=0;const o=12,s=5e3;return new Promise(i=>{ee(n,Le.test(n)?"space_name":"subdomain",r=>{t(r),r.status==="running"||r.status==="error"||r.status==="paused"||r.status==="space_error"?i():(r.status==="sleeping"||r.status==="building")&&(e<o?(e++,setTimeout(()=>{it(n,t).then(i)},s)):i())})})},an=/^(?=[^]*\b[dD]iscussions{0,1}\b)(?=[^]*\b[dD]isabled\b)[^]*$/;async function Me(n){try{const t=await fetch(`https://huggingface.co/api/spaces/${n}/discussions`,{method:"HEAD"}),e=t.headers.get("x-error-message");return!(!t.ok||e&&an.test(e))}catch{return!1}}async function cn(n,t){const e={};t&&(e.Authorization=`Bearer ${t}`);try{const o=await fetch(`https://huggingface.co/api/spaces/${n}/${Ot}`,{headers:e});if(o.status!==200)throw new Error("Space hardware could not be obtained.");const{hardware:s}=await o.json();return s.current}catch(o){throw new Error(o.message)}}async function ln(n,t,e){const o={};e&&(o.Authorization=`Bearer ${e}`);const s={seconds:t};try{const i=await fetch(`https://huggingface.co/api/spaces/${n}/${Tt}`,{method:"POST",headers:{"Content-Type":"application/json",...o},body:JSON.stringify(s)});if(i.status!==200)throw new Error("Could not set sleep timeout on duplicated Space. Please visit *ADD HF LINK TO SETTINGS* to set a timeout manually to reduce billing charges.");return await i.json()}catch(i){throw new Error(i.message)}}const We=["cpu-basic","cpu-upgrade","cpu-xl","t4-small","t4-medium","a10g-small","a10g-large","a10g-largex2","a10g-largex4","a100-large","zero-a10g","h100","h100x8"];async function un(n,t){const{hf_token:e,private:o,hardware:s,timeout:i,auth:r}=t;if(s&&!We.includes(s))throw new Error(`Invalid hardware type provided. Valid types are: ${We.map(g=>`"${g}"`).join(",")}.`);const{http_protocol:a,host:c}=await ue(n,e);let f=null;if(r){const g=await tt(a,c,r,fetch);g&&(f=nt(g))}const h={Authorization:`Bearer ${e}`,"Content-Type":"application/json",...f?{Cookie:f.join("; ")}:{}},u=(await(await fetch("https://huggingface.co/api/whoami-v2",{headers:h})).json()).name,_=n.split("/")[1],v={repository:`${u}/${_}`};o&&(v.private=!0);let z;try{s||(z=await cn(n,e))}catch(g){throw Error(Te+g.message)}const l=s||z||"cpu-basic";v.hardware=l;try{const g=await fetch(`https://huggingface.co/api/spaces/${n}/duplicate`,{method:"POST",headers:h,body:JSON.stringify(v)});if(g.status===409)try{return await re.connect(`${u}/${_}`,t)}catch(I){throw console.error("Failed to connect Client instance:",I),I}else if(g.status!==200)throw new Error(g.statusText);const O=await g.json();return await ln(`${u}/${_}`,i||300,e),await re.connect(dn(O.url),t)}catch(g){throw new Error(g)}}function dn(n){const t=/https:\/\/huggingface.co\/spaces\/([^/]+\/[^/]+)/,e=n.match(t);if(e)return e[1]}class pn extends TransformStream{constructor(t={allowCR:!1}){super({transform:(e,o)=>{for(e=X(this,q)+e;;){const s=e.indexOf(`
`),i=t.allowCR?e.indexOf("\r"):-1;if(i!==-1&&i!==e.length-1&&(s===-1||s-1>i)){o.enqueue(e.slice(0,i)),e=e.slice(i+1);continue}if(s===-1)break;const r=e[s-1]==="\r"?s-1:s;o.enqueue(e.slice(0,r)),e=e.slice(s+1)}bt(this,q,e)},flush:e=>{if(X(this,q)==="")return;const o=t.allowCR&&X(this,q).endsWith("\r")?X(this,q).slice(0,-1):X(this,q);e.enqueue(o)}}),vt(this,q,"")}}q=new WeakMap;function fn(n){let t=new TextDecoderStream,e=new pn({allowCR:!0});return n.pipeThrough(t).pipeThrough(e)}function hn(n){let e=/[:]\s*/.exec(n),o=e&&e.index;if(o)return[n.substring(0,o),n.substring(o+e[0].length)]}function Je(n,t,e){n.get(t)||n.set(t,e)}async function*_n(n,t){if(!n.body)return;let e=fn(n.body),o,s=e.getReader(),i;for(;;){if(t&&t.aborted)return s.cancel();if(o=await s.read(),o.done)return;if(!o.value){i&&(yield i),i=void 0;continue}let[r,a]=hn(o.value)||[];r&&(r==="data"?(i||(i={}),i[r]=i[r]?i[r]+`
`+a:a):r==="event"?(i||(i={}),i[r]=a):r==="id"?(i||(i={}),i[r]=+a||a):r==="retry"&&(i||(i={}),i[r]=+a||void 0))}}async function mn(n,t){let e=new Request(n,t);Je(e.headers,"Accept","text/event-stream"),Je(e.headers,"Content-Type","application/json");let o=await fetch(e);if(!o.ok)throw o;return _n(o,e.signal)}async function gn(){let{event_callbacks:n,unclosed_events:t,pending_stream_messages:e,stream_status:o,config:s,jwt:i}=this;const r=this;if(!s)throw new Error("Could not resolve app config");o.open=!0;let a=null,c=new URLSearchParams({session_hash:this.session_hash}).toString(),f=new URL(`${s.root}${this.api_prefix}/${Ze}?${c}`);if(i&&f.searchParams.set("__sign",i),a=this.stream(f),!a){console.warn("Cannot connect to SSE endpoint: "+f.toString());return}a.onmessage=async function(h){let u=JSON.parse(h.data);if(u.msg==="close_stream"){ie(o,r.abort_controller);return}const _=u.event_id;if(!_)await Promise.all(Object.keys(n).map(v=>n[v](u)));else if(n[_]&&s){u.msg==="process_completed"&&["sse","sse_v1","sse_v2","sse_v2.1","sse_v3"].includes(s.protocol)&&t.delete(_);let v=n[_];typeof window<"u"&&typeof document<"u"?setTimeout(v,0,u):v(u)}else e[_]||(e[_]=[]),e[_].push(u)},a.onerror=async function(){await Promise.all(Object.keys(n).map(h=>n[h]({msg:"unexpected_error",message:G})))}}function ie(n,t){n&&(n.open=!1,t==null||t.abort())}function wn(n,t,e){!n[t]?(n[t]=[],e.data.forEach((s,i)=>{n[t][i]=s})):e.data.forEach((s,i)=>{let r=yn(n[t][i],s);n[t][i]=r,e.data[i]=r})}function yn(n,t){return t.forEach(([e,o,s])=>{n=vn(n,o,e,s)}),n}function vn(n,t,e,o){if(t.length===0){if(e==="replace")return o;if(e==="append")return n+o;throw new Error(`Unsupported action: ${e}`)}let s=n;for(let r=0;r<t.length-1;r++)s=s[t[r]];const i=t[t.length-1];switch(e){case"replace":s[i]=o;break;case"append":s[i]+=o;break;case"add":Array.isArray(s)?s.splice(Number(i),0,o):s[i]=o;break;case"delete":Array.isArray(s)?s.splice(Number(i),1):delete s[i];break;default:throw new Error(`Unknown action: ${e}`)}return n}function bn(n,t={}){const e={close:()=>{console.warn("Method not implemented.")},onerror:null,onmessage:null,onopen:null,readyState:0,url:n.toString(),withCredentials:!1,CONNECTING:0,OPEN:1,CLOSED:2,addEventListener:()=>{throw new Error("Method not implemented.")},dispatchEvent:()=>{throw new Error("Method not implemented.")},removeEventListener:()=>{throw new Error("Method not implemented.")}};return mn(n,t).then(async o=>{e.readyState=e.OPEN;try{for await(const s of o)e.onmessage&&e.onmessage(s);e.readyState=e.CLOSED}catch(s){e.onerror&&e.onerror(s),e.readyState=e.CLOSED}}).catch(o=>{console.error(o),e.onerror&&e.onerror(o),e.readyState=e.CLOSED}),e}function En(n,t={},e,o,s){var i;try{let r=function(w){(s||pt[w.type])&&h(w)},a=function(){for(me=!0;Q.length>0;)Q.shift()({value:void 0,done:!0})},c=function(w){me||(Q.length>0?Q.shift()(w):ge.push(w))},f=function(w){c(Sn(w)),a()},h=function(w){c({value:w,done:!1})},u=function(){return ge.length>0?Promise.resolve(ge.shift()):me?Promise.resolve({value:void 0,done:!0}):new Promise(w=>Q.push(w))};const{hf_token:_}=this.options,{fetch:v,app_reference:z,config:l,session_hash:g,api_info:O,api_map:I,stream_status:ne,pending_stream_messages:de,pending_diff_streams:pe,event_callbacks:fe,unclosed_events:lt,post_data:he,options:M,api_prefix:W}=this,Ce=this;if(!O)throw new Error("No API found");if(!l)throw new Error("Could not resolve app config");let{fn_index:p,endpoint_info:De,dependency:J}=$n(O,n,I,l),ut=Vt(t,De),k,C,D=l.protocol??"ws",Ue="",dt=()=>Ue;const m=typeof n=="number"?"/predict":n;let Z,E=null,R=!1,_e={},F=typeof window<"u"&&typeof document<"u"?new URLSearchParams(window.location.search).toString():"";const pt=((i=M==null?void 0:M.events)==null?void 0:i.reduce((w,A)=>(w[A]=!0,w),{}))||{};async function ft(){const w={stage:"complete",queue:!1,time:new Date};R=w,r({...w,type:"status",endpoint:m,fn_index:p});let A={},H={};D==="ws"?(k&&k.readyState===0?k.addEventListener("open",()=>{k.close()}):k.close(),A={fn_index:p,session_hash:g}):(ie(ne,Ce.abort_controller),a(),A={event_id:E},H={event_id:E,session_hash:g,fn_index:p});try{if(!l)throw new Error("Could not resolve app config");"event_id"in H&&await v(`${l.root}${W}/${Pt}`,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify(H)}),await v(`${l.root}${W}/${At}`,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify(A)})}catch{console.warn("The `/reset` endpoint could not be called. Subsequent endpoint results may be unreliable.")}}const ht=async w=>{await this._resolve_hearbeat(w)};async function Ne(w){if(!l)return;let A=w.render_id;l.components=[...l.components.filter(y=>y.props.rendered_in!==A),...w.components],l.dependencies=[...l.dependencies.filter(y=>y.rendered_in!==A),...w.dependencies];const H=l.components.some(y=>y.type==="state"),se=l.dependencies.some(y=>y.targets.some(N=>N[1]==="unload"));l.connect_heartbeat=H||se,await ht(l),r({type:"render",data:w,endpoint:m,fn_index:p})}this.handle_blob(l.root,ut,De).then(async w=>{var A;if(Z={data:Y(w,J,l.components,"input",!0)||[],event_data:e,fn_index:p,trigger_id:o},Yt(p,l))r({type:"status",endpoint:m,stage:"pending",queue:!1,fn_index:p,time:new Date}),he(`${l.root}${W}/run${m.startsWith("/")?m:`/${m}`}${F?"?"+F:""}`,{...Z,session_hash:g}).then(([y,N])=>{const B=y.data;N==200?(r({type:"data",endpoint:m,fn_index:p,data:Y(B,J,l.components,"output",M.with_null_state),time:new Date,event_data:e,trigger_id:o}),y.render_config&&Ne(y.render_config),r({type:"status",endpoint:m,fn_index:p,stage:"complete",eta:y.average_duration,queue:!1,time:new Date})):r({type:"status",stage:"error",endpoint:m,fn_index:p,message:y.error,queue:!1,time:new Date})}).catch(y=>{r({type:"status",stage:"error",message:y.message,endpoint:m,fn_index:p,queue:!1,time:new Date})});else if(D=="ws"){const{ws_protocol:y,host:N}=await ue(z,_);r({type:"status",stage:"pending",queue:!0,endpoint:m,fn_index:p,time:new Date});let B=new URL(`${y}://${et(N,l.path,!0)}/queue/join${F?"?"+F:""}`);this.jwt&&B.searchParams.set("__sign",this.jwt),k=new WebSocket(B),k.onclose=P=>{P.wasClean||r({type:"status",stage:"error",broken:!0,message:G,queue:!0,endpoint:m,fn_index:p,time:new Date})},k.onmessage=function(P){const T=JSON.parse(P.data),{type:S,status:$,data:L}=be(T,_e[p]);if(S==="update"&&$&&!R)r({type:"status",endpoint:m,fn_index:p,time:new Date,...$}),$.stage==="error"&&k.close();else if(S==="hash"){k.send(JSON.stringify({fn_index:p,session_hash:g}));return}else S==="data"?k.send(JSON.stringify({...Z,session_hash:g})):S==="complete"?R=$:S==="log"?r({type:"log",title:L.title,log:L.log,level:L.level,endpoint:m,duration:L.duration,visible:L.visible,fn_index:p}):S==="generating"&&r({type:"status",time:new Date,...$,stage:$==null?void 0:$.stage,queue:!0,endpoint:m,fn_index:p});L&&(r({type:"data",time:new Date,data:Y(L.data,J,l.components,"output",M.with_null_state),endpoint:m,fn_index:p,event_data:e,trigger_id:o}),R&&(r({type:"status",time:new Date,...R,stage:$==null?void 0:$.stage,queue:!0,endpoint:m,fn_index:p}),k.close()))},Ke(l.version||"2.0.0","3.6")<0&&addEventListener("open",()=>k.send(JSON.stringify({hash:g})))}else if(D=="sse"){r({type:"status",stage:"pending",queue:!0,endpoint:m,fn_index:p,time:new Date});var se=new URLSearchParams({fn_index:p.toString(),session_hash:g}).toString();let y=new URL(`${l.root}${W}/${Ze}?${F?F+"&":""}${se}`);if(this.jwt&&y.searchParams.set("__sign",this.jwt),C=this.stream(y),!C)return Promise.reject(new Error("Cannot connect to SSE endpoint: "+y.toString()));C.onmessage=async function(N){const B=JSON.parse(N.data),{type:P,status:T,data:S}=be(B,_e[p]);if(P==="update"&&T&&!R)r({type:"status",endpoint:m,fn_index:p,time:new Date,...T}),T.stage==="error"&&(C==null||C.close(),a());else if(P==="data"){let[$,L]=await he(`${l.root}${W}/queue/data`,{...Z,session_hash:g,event_id:E});L!==200&&(r({type:"status",stage:"error",message:G,queue:!0,endpoint:m,fn_index:p,time:new Date}),C==null||C.close(),a())}else P==="complete"?R=T:P==="log"?r({type:"log",title:S.title,log:S.log,level:S.level,endpoint:m,duration:S.duration,visible:S.visible,fn_index:p}):(P==="generating"||P==="streaming")&&r({type:"status",time:new Date,...T,stage:T==null?void 0:T.stage,queue:!0,endpoint:m,fn_index:p});S&&(r({type:"data",time:new Date,data:Y(S.data,J,l.components,"output",M.with_null_state),endpoint:m,fn_index:p,event_data:e,trigger_id:o}),R&&(r({type:"status",time:new Date,...R,stage:T==null?void 0:T.stage,queue:!0,endpoint:m,fn_index:p}),C==null||C.close(),a()))}}else if(D=="sse_v1"||D=="sse_v2"||D=="sse_v2.1"||D=="sse_v3"){r({type:"status",stage:"pending",queue:!0,endpoint:m,fn_index:p,time:new Date});let y="";typeof window<"u"&&typeof document<"u"&&(y=(A=window==null?void 0:window.location)==null?void 0:A.hostname);const B=y.includes(".dev.")?`https://moon-${y.split(".")[1]}.dev.spaces.huggingface.tech`:"https://huggingface.co";(typeof window<"u"&&typeof document<"u"&&window.parent!=window&&window.supports_zerogpu_headers?en("zerogpu-headers",B):Promise.resolve(null)).then($=>he(`${l.root}${W}/${St}?${F}`,{...Z,session_hash:g},$)).then(async([$,L])=>{if(L===503)r({type:"status",stage:"error",message:Qe,queue:!0,endpoint:m,fn_index:p,time:new Date});else if(L!==200)r({type:"status",stage:"error",message:G,queue:!0,endpoint:m,fn_index:p,time:new Date});else{E=$.event_id,Ue=E;let qe=async function(we){try{const{type:U,status:b,data:x,original_msg:_t}=be(we,_e[p]);if(U=="heartbeat")return;if(U==="update"&&b&&!R)r({type:"status",endpoint:m,fn_index:p,time:new Date,original_msg:_t,...b});else if(U==="complete")R=b;else if(U=="unexpected_error")console.error("Unexpected error",b==null?void 0:b.message),r({type:"status",stage:"error",message:(b==null?void 0:b.message)||"An Unexpected Error Occurred!",queue:!0,endpoint:m,fn_index:p,time:new Date});else if(U==="log"){r({type:"log",title:x.title,log:x.log,level:x.level,endpoint:m,duration:x.duration,visible:x.visible,fn_index:p});return}else(U==="generating"||U==="streaming")&&(r({type:"status",time:new Date,...b,stage:b==null?void 0:b.stage,queue:!0,endpoint:m,fn_index:p}),x&&J.connection!=="stream"&&["sse_v2","sse_v2.1","sse_v3"].includes(D)&&wn(pe,E,x));x&&(r({type:"data",time:new Date,data:Y(x.data,J,l.components,"output",M.with_null_state),endpoint:m,fn_index:p}),x.render_config&&await Ne(x.render_config),R&&(r({type:"status",time:new Date,...R,stage:b==null?void 0:b.stage,queue:!0,endpoint:m,fn_index:p}),a())),((b==null?void 0:b.stage)==="complete"||(b==null?void 0:b.stage)==="error")&&(fe[E]&&delete fe[E],E in pe&&delete pe[E])}catch(U){console.error("Unexpected client exception",U),r({type:"status",stage:"error",message:"An Unexpected Error Occurred!",queue:!0,endpoint:m,fn_index:p,time:new Date}),["sse_v2","sse_v2.1","sse_v3"].includes(D)&&(ie(ne,Ce.abort_controller),ne.open=!1,a())}};E in de&&(de[E].forEach(we=>qe(we)),delete de[E]),fe[E]=qe,lt.add(E),ne.open||await this.open_stream()}})}});let me=!1;const ge=[],Q=[],Be={[Symbol.asyncIterator]:()=>Be,next:u,throw:async w=>(f(w),u()),return:async()=>(a(),u()),cancel:ft,event_id:dt};return Be}catch(r){throw console.error("Submit function encountered an error:",r),r}}function Sn(n){return{then:(t,e)=>e(n)}}function $n(n,t,e,o){let s,i,r;if(typeof t=="number")s=t,i=n.unnamed_endpoints[s],r=o.dependencies.find(a=>a.id==t);else{const a=t.replace(/^\//,"");s=e[a],i=n.named_endpoints[t.trim()],r=o.dependencies.find(c=>c.id==e[a])}if(typeof s!="number")throw new Error("There is no endpoint matching that name of fn_index matching that number.");return{fn_index:s,endpoint_info:i,dependency:r}}class re{constructor(t,e={events:["data"]}){d(this,"app_reference"),d(this,"options"),d(this,"config"),d(this,"api_prefix",""),d(this,"api_info"),d(this,"api_map",{}),d(this,"session_hash",Math.random().toString(36).substring(2)),d(this,"jwt",!1),d(this,"last_status",{}),d(this,"cookies",null),d(this,"stream_status",{open:!1}),d(this,"closed",!1),d(this,"pending_stream_messages",{}),d(this,"pending_diff_streams",{}),d(this,"event_callbacks",{}),d(this,"unclosed_events",new Set),d(this,"heartbeat_event",null),d(this,"abort_controller",null),d(this,"stream_instance",null),d(this,"current_payload"),d(this,"ws_map",{}),d(this,"view_api"),d(this,"upload_files"),d(this,"upload"),d(this,"handle_blob"),d(this,"post_data"),d(this,"submit"),d(this,"predict"),d(this,"open_stream"),d(this,"resolve_config"),d(this,"resolve_cookies"),this.app_reference=t,e.events||(e.events=["data"]),this.options=e,this.current_payload={},this.view_api=Kt.bind(this),this.upload_files=Zt.bind(this),this.handle_blob=tn.bind(this),this.post_data=on.bind(this),this.submit=En.bind(this),this.predict=rn.bind(this),this.open_stream=gn.bind(this),this.resolve_config=Ft.bind(this),this.resolve_cookies=Gt.bind(this),this.upload=Qt.bind(this),this.fetch=this.fetch.bind(this),this.handle_space_success=this.handle_space_success.bind(this),this.stream=this.stream.bind(this)}get_url_config(t=null){if(!this.config)throw new Error(j);t===null&&(t=window.location.href);const e=r=>r.replace(/^\/+|\/+$/g,"");let o=e(new URL(this.config.root).pathname),s=e(new URL(t).pathname),i;return s.startsWith(o)?i=e(s.substring(o.length)):i="",this.get_page_config(i)}get_page_config(t){if(!this.config)throw new Error(j);let e=this.config;return t in e.page||(t=""),{...e,current_page:t,layout:e.page[t].layout,components:e.components.filter(o=>e.page[t].components.includes(o.id)),dependencies:this.config.dependencies.filter(o=>e.page[t].dependencies.includes(o.id))}}fetch(t,e){const o=new Headers((e==null?void 0:e.headers)||{});if(this&&this.cookies&&o.append("Cookie",this.cookies),this&&this.options.headers)for(const s in this.options.headers)o.append(s,this.options.headers[s]);return fetch(t,{...e,headers:o})}stream(t){const e=new Headers;if(this&&this.cookies&&e.append("Cookie",this.cookies),this&&this.options.headers)for(const o in this.options.headers)e.append(o,this.options.headers[o]);return this.abort_controller=new AbortController,this.stream_instance=bn(t.toString(),{credentials:"include",headers:e,signal:this.abort_controller.signal}),this.stream_instance}async init(){var t;if((typeof window>"u"||!("WebSocket"in window))&&!global.WebSocket){const e=await $e(()=>import("./wrapper-CviSselG-BXl6tbvB.js"),__vite__mapDeps([0,1]));global.WebSocket=e.WebSocket}this.options.auth&&await this.resolve_cookies(),await this._resolve_config().then(({config:e})=>this._resolve_hearbeat(e)),this.api_info=await this.view_api(),this.api_map=zt(((t=this.config)==null?void 0:t.dependencies)||[])}async _resolve_hearbeat(t){if(t&&(this.config=t,this.api_prefix=t.api_prefix||"",this.config&&this.config.connect_heartbeat&&this.config.space_id&&this.options.hf_token&&(this.jwt=await Fe(this.config.space_id,this.options.hf_token,this.cookies))),t.space_id&&this.options.hf_token&&(this.jwt=await Fe(t.space_id,this.options.hf_token)),this.config&&this.config.connect_heartbeat){const e=new URL(`${this.config.root}${this.api_prefix}/${Lt}/${this.session_hash}`);this.jwt&&e.searchParams.set("__sign",this.jwt),this.heartbeat_event||(this.heartbeat_event=this.stream(e))}}static async connect(t,e={events:["data"]}){const o=new this(t,e);return await o.init(),o}close(){this.closed=!0,ie(this.stream_status,this.abort_controller)}set_current_payload(t){this.current_payload=t}static async duplicate(t,e={events:["data"]}){return un(t,e)}async _resolve_config(){const{http_protocol:t,host:e,space_id:o}=await ue(this.app_reference,this.options.hf_token),{status_callback:s}=this.options;o&&s&&await it(o,s);let i;try{if(i=await this.resolve_config(`${t}//${e}`),!i)throw new Error(j);return this.config_success(i)}catch(r){if(o&&s)ee(o,Le.test(o)?"space_name":"subdomain",this.handle_space_success);else throw s&&s({status:"error",message:"Could not load this space.",load_status:"error",detail:"NOT_FOUND"}),Error(r)}}async config_success(t){if(this.config=t,this.api_prefix=t.api_prefix||"",typeof window<"u"&&typeof document<"u"&&window.location.protocol==="https:"&&(this.config.root=this.config.root.replace("http://","https://")),this.config.auth_required)return this.prepare_return_obj();try{this.api_info=await this.view_api()}catch(e){console.error(Dt+e.message)}return this.prepare_return_obj()}async handle_space_success(t){var e;if(!this)throw new Error(j);const{status_callback:o}=this.options;if(o&&o(t),t.status==="running")try{if(this.config=await this._resolve_config(),this.api_prefix=((e=this==null?void 0:this.config)==null?void 0:e.api_prefix)||"",!this.config)throw new Error(j);return await this.config_success(this.config)}catch(s){throw o&&o({status:"error",message:"Could not load this space.",load_status:"error",detail:"NOT_FOUND"}),s}}async component_server(t,e,o){var s;if(!this.config)throw new Error(j);const i={},{hf_token:r}=this.options,{session_hash:a}=this;r&&(i.Authorization=`Bearer ${this.options.hf_token}`);let c,f=this.config.components.find(u=>u.id===t);(s=f==null?void 0:f.props)!=null&&s.root_url?c=f.props.root_url:c=this.config.root;let h;if("binary"in o){h=new FormData;for(const u in o.data)u!=="binary"&&h.append(u,o.data[u]);h.set("component_id",t.toString()),h.set("fn_name",e),h.set("session_hash",a)}else h=JSON.stringify({data:o,component_id:t,fn_name:e,session_hash:a}),i["Content-Type"]="application/json";r&&(i.Authorization=`Bearer ${r}`);try{const u=await this.fetch(`${c}${this.api_prefix}/${It}/`,{method:"POST",body:h,headers:i,credentials:"include"});if(!u.ok)throw new Error("Could not connect to component server: "+u.statusText);return await u.json()}catch(u){console.warn(u)}}set_cookies(t){this.cookies=nt(t).join("; ")}prepare_return_obj(){return{config:this.config,predict:this.predict,submit:this.submit,view_api:this.view_api,component_server:this.component_server}}async connect_ws(t){return new Promise((e,o)=>{let s;try{s=new WebSocket(t)}catch{this.ws_map[t]="failed";return}s.onopen=()=>{e()},s.onerror=i=>{console.error("WebSocket error:",i),this.close_ws(t),this.ws_map[t]="failed",e()},s.onclose=()=>{delete this.ws_map[t],this.ws_map[t]="failed"},s.onmessage=i=>{},this.ws_map[t]=s})}async send_ws_message(t,e){t in this.ws_map||await this.connect_ws(t);const o=this.ws_map[t];o instanceof WebSocket?o.send(JSON.stringify(e)):this.post_data(t,e)}async close_ws(t){if(t in this.ws_map){const e=this.ws_map[t];e instanceof WebSocket&&(e.close(),delete this.ws_map[t])}}}const Ae={apiHost:"https://louder-dhpcppvhis.cn-hangzhou.fcapp.run",timeEstimateRate:.1},rt=document.getElementById("error-dialog"),kn=document.getElementById("error-info"),Rn=document.getElementById("close-error");Rn.addEventListener("click",()=>{rt.close()});function V(n){kn.innerHTML=n,rt.showModal()}const Ee=document.getElementById("voice-upload"),He=document.getElementById("record-state"),On=document.getElementById("voice-record"),at=document.getElementById("voice-preview");let Pe=null;Ee.addEventListener("change",async()=>{at.src=URL.createObjectURL(Ee.files[0]),Pe=Ee.files[0]});let Se=null;async function Tn(){if(!Se)try{const n=await navigator.mediaDevices.getUserMedia({audio:!0});Se=new MediaRecorder(n)}catch(n){return V("无法获取录音权限"),Promise.reject(n)}return Se}async function Ln(n){const t=await n.arrayBuffer(),e=In(t.byteLength);return new Blob([e,t],{type:"audio/wav"})}function In(n){const t=new ArrayBuffer(44),e=new DataView(t);return o(e,0,"RIFF"),e.setUint32(4,n+36,!0),o(e,8,"WAVE"),o(e,12,"fmt "),e.setUint32(16,16,!0),e.setUint16(20,1,!0),e.setUint16(22,1,!0),e.setUint32(24,16e3,!0),e.setUint32(28,32e3,!0),e.setUint16(32,2,!0),e.setUint16(34,16,!0),o(e,36,"data"),e.setUint32(40,n,!0),t;function o(s,i,r){for(let a=0;a<r.length;a++)s.setUint8(i+a,r.charCodeAt(a))}}On.addEventListener("click",async()=>{const n=await Tn();if(n.state==="recording"){n.stop(),He.innerText="开始录音";return}let t=[];n.addEventListener("dataavailable",e=>{t.push(e.data)}),n.addEventListener("stop",async()=>{const e=new Blob(t,{type:"audio/wav"});at.src=URL.createObjectURL(e),Pe=await Ln(e),t=[]}),n.start(),He.innerText="录音中"});let ae="clone";const ce={clone:document.getElementById("tab-clone"),create:document.getElementById("tab-creation")};function An(n){ce[ae].setAttribute("aria-selected","false"),ce[n].setAttribute("aria-selected","true"),ae=n}(function(){for(const n in ce)ce[n].addEventListener("click",()=>{An(n)})})();const te=document.getElementById("text-to-speak"),Re=document.getElementById("pitch"),Oe=document.getElementById("speed"),Pn=document.getElementById("pitch-label"),xn=document.getElementById("speed-label"),K=document.getElementById("generate"),xe=document.getElementById("result"),Cn=document.getElementById("download");Re.addEventListener("input",()=>{Pn.innerText=`${Re.value}`});Oe.addEventListener("input",()=>{xn.innerText=`${Oe.value}`});K.addEventListener("click",()=>{ae==="create"?Dn():ae==="clone"&&Un()});Cn.addEventListener("click",()=>{const n=xe.src;if(!n){V("音频不存在");return}const t=document.createElement("a");t.href=n,t.download=`TTS_${Date.now()}.wav`,t.style.display="none",document.body.appendChild(t),t.click(),document.body.removeChild(t)});let oe=null;function ct(){te.disabled=!0,K.disabled=!0,K.innerText="连接中...";let n=Math.round(te.value.length*Ae.timeEstimateRate+10),t=0;oe=setInterval(()=>{K.innerText=`生成中，预估用时 ${n}s (${t}s)`,t++},1e3)}function le(){te.disabled=!1,K.disabled=!1,K.innerText="生成语音",oe!==null&&(clearInterval(oe),oe=null)}async function Dn(){const n=te.value,t=document.querySelector("input[name='gender']:checked"),e=parseFloat(Re.value),o=parseFloat(Oe.value);console.log(`Gender: ${t.value}, Pitch: ${e}, Speed: ${o}`),ct();try{const i=await(await re.connect(Ae.apiHost)).predict("/voice_creation",{text:n,gender:t.value,pitch:e,speed:o});le(),console.log(i),xe.src=i.data[0].url}catch(s){le(),console.error("An unexpected error occurred:",s),V("An unexpected error occurred while creating the voice. Please try again.")}}async function Un(){const n=te.value,t=Pe;console.log(t);const e=document.getElementById("training-text").value;if(!t){V("请上传音频文件或录制音频");return}if(e.length===0){V("请输入训练文本");return}ct();try{const s=await(await re.connect(Ae.apiHost)).predict("/voice_clone",{text:n,prompt_text:e,prompt_wav_upload:t,prompt_wav_record:t});le(),console.log(s),xe.src=s.data[0].url}catch(o){le(),console.error("An unexpected error occurred:",o),V("An unexpected error occurred while cloning the voice. Please try again.")}}
